apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  labels:
    app.kubernetes.io/component: postgres
data:
  init-databases.sh: |
    #!/bin/bash
    set -e

    # The default database (POSTGRES_DB) is created automatically by the
    # postgres entrypoint. This script creates the additional keycloak
    # database and user.

    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
      CREATE USER keycloak WITH PASSWORD 'keycloak-secret';
      CREATE DATABASE keycloak OWNER keycloak;
      GRANT ALL PRIVILEGES ON DATABASE keycloak TO keycloak;
    EOSQL
