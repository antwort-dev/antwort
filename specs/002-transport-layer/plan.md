# Implementation Plan: Transport Layer

**Branch**: `002-transport-layer` | **Date**: 2026-02-17 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-transport-layer/spec.md`

## Summary

Implement the HTTP/SSE transport layer for antwort, providing request routing, streaming event delivery, middleware chain, and connection lifecycle management. The transport layer defines handler interfaces (ResponseCreator, ResponseStore, ResponseWriter) and implements an HTTP adapter using Go standard library only. All testing uses mock handlers, since the core engine is defined in a later spec.

## Technical Context

**Language/Version**: Go 1.22+ (required for `http.ServeMux` method+pattern routing)
**Primary Dependencies**: Go standard library only (`net/http`, `log/slog`, `encoding/json`, `context`, `sync`, `os/signal`)
**Storage**: N/A (transport layer has no persistence; ResponseStore is an interface for future specs)
**Testing**: `go test` with `net/http/httptest` for HTTP integration tests
**Target Platform**: Linux server (also works on macOS/Windows for development)
**Project Type**: Single project (library + server components)
**Constraints**: Zero external dependencies, consistent with Spec 001

## Constitution Check

*Constitution is a template (not filled in). No gates to check.*

## Project Structure

### Documentation (this feature)

```text
specs/002-transport-layer/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity and interface design
├── quickstart.md        # Usage guide with code examples
├── contracts/
│   └── sse-wire-format.md  # SSE wire format contract
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
pkg/transport/
├── handler.go           # ResponseCreator, ResponseStore, ResponseWriter interfaces
├── middleware.go         # Middleware type, chain builder, context keys
├── recovery.go          # Recovery middleware (panic -> 500)
├── requestid.go         # Request ID middleware (X-Request-ID)
├── logging.go           # Logging middleware (structured log/slog)
├── server.go            # Server struct, config, startup, graceful shutdown
├── inflight.go          # In-flight registry for cancellation
├── handler_test.go      # Interface contract tests
├── middleware_test.go    # Middleware chain and built-in middleware tests
├── server_test.go       # HTTP integration tests
├── inflight_test.go     # Registry concurrency tests
└── http/
    ├── adapter.go       # HTTP adapter (routes, request parsing, response writing)
    ├── sse.go           # SSE ResponseWriter implementation
    ├── adapter_test.go  # HTTP adapter integration tests
    └── sse_test.go      # SSE wire format tests
```

**Structure Decision**: The transport layer lives in `pkg/transport/` with the HTTP-specific adapter in a `http/` sub-package. This allows future adapters (gRPC) to be added as sibling sub-packages without modifying the core transport interfaces.

## Key Design Decisions

### RT-1: Go 1.22 ServeMux Routing
Use `http.ServeMux` with method+pattern routing (`POST /v1/responses`, `GET /v1/responses/{id}`). Automatic 405 Method Not Allowed for mismatched methods. Path parameters via `r.PathValue("id")`.

### RT-2: SSE via http.NewResponseController
Use `http.NewResponseController` (Go 1.20+) for flushing. Works through middleware wrappers, returns errors from `Flush()`, supports per-request deadline control.

### RT-3: Graceful Shutdown
Use `http.Server.Shutdown()` with `signal.NotifyContext` and a configurable timeout (default 30s). Server runs in a goroutine; main goroutine waits for OS signals.

### RT-4: Structured Logging with log/slog
Use `log/slog` for structured logging middleware. Request-scoped attributes stored in context.

### RT-5: Body Size Limiting
Use `http.MaxBytesReader` to wrap `r.Body` before JSON decoding. Returns `*http.MaxBytesError` on overflow, mapped to HTTP 413.

### RT-6: Client Disconnect Detection
Rely on `http.Request.Context()` cancellation. For SSE, `rc.Flush()` errors also indicate disconnection. Both mechanisms propagate to the handler.

### RT-7: Middleware Pattern
Function composition: `type Middleware func(ResponseCreator) ResponseCreator`. HTTP-level middleware uses the standard `func(http.Handler) http.Handler` pattern. The HTTP adapter bridges the two.

## Dependency Map

```
pkg/transport/
  ├── imports pkg/api (types, events, errors from Spec 001)
  └── imports Go stdlib (net/http, log/slog, encoding/json, context, sync, os/signal)

pkg/transport/http/
  ├── imports pkg/transport (interfaces)
  └── imports pkg/api (for JSON serialization)
```

No circular dependencies. `pkg/api` has no dependency on `pkg/transport`.
