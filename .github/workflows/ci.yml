name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Run go vet
        run: go vet ./pkg/... ./cmd/...

      - name: Run unit tests
        run: go test ./pkg/... -timeout 60s -count=1

  conformance:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Install oasdiff
        run: go install github.com/oasdiff/oasdiff@latest

      - name: Run oasdiff validation
        run: ./api/validate-oasdiff.sh

      - name: Run integration tests
        run: go test ./test/integration/ -timeout 120s -v -count=1

      - name: Build binaries
        run: |
          go build -o bin/server ./cmd/server/
          go build -o bin/mock-backend ./cmd/mock-backend/

      - name: Start mock backend
        run: |
          MOCK_PORT=9090 ./bin/mock-backend &
          echo "MOCK_PID=$!" >> $GITHUB_ENV

      - name: Start antwort server
        run: |
          ANTWORT_BACKEND_URL="http://localhost:9090" \
          ANTWORT_MODEL="mock-model" \
          ANTWORT_PORT="8080" \
          ANTWORT_STORAGE="memory" \
          ./bin/server &
          echo "SERVER_PID=$!" >> $GITHUB_ENV

      - name: Wait for services
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/healthz > /dev/null 2>&1; then
              echo "Services ready after ${i}s"
              exit 0
            fi
            sleep 1
          done
          echo "ERROR: Services did not start within 30s"
          exit 1

      - uses: oven-sh/setup-bun@v2

      - name: Clone OpenResponses compliance suite
        run: git clone --depth 1 https://github.com/openresponses/openresponses.git /tmp/openresponses

      - name: Install compliance suite dependencies
        run: cd /tmp/openresponses && bun install --frozen-lockfile

      - name: Run compliance tests (JSON)
        id: compliance
        run: |
          cd /tmp/openresponses
          bun run bin/compliance-test.ts \
            --base-url "http://localhost:8080/v1" \
            --model "mock-model" \
            --api-key "test" \
            --json > /tmp/compliance-results.json 2>&1 || true
          cat /tmp/compliance-results.json

      - name: Run compliance tests (verbose)
        run: |
          cd /tmp/openresponses
          bun run bin/compliance-test.ts \
            --base-url "http://localhost:8080/v1" \
            --model "mock-model" \
            --api-key "test"

      - name: Generate summary
        if: always()
        run: |
          if [ -f /tmp/compliance-results.json ] && jq -e '.summary' /tmp/compliance-results.json > /dev/null 2>&1; then
            PASSED=$(jq -r '.summary.passed' /tmp/compliance-results.json)
            FAILED=$(jq -r '.summary.failed' /tmp/compliance-results.json)
            TOTAL=$(jq -r '.summary.total' /tmp/compliance-results.json)

            echo "## OpenResponses Conformance: ${PASSED}/${TOTAL}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test | Status | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|----------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | "| \(.id) | \(if .status == "passed" then "PASS" else "FAIL" end) | \(.duration // "-")ms |"' \
              /tmp/compliance-results.json >> $GITHUB_STEP_SUMMARY

            if [ "$FAILED" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Failures" >> $GITHUB_STEP_SUMMARY
              jq -r '.results[] | select(.status == "failed") | "- **\(.id)**: \(.errors[0] // "unknown")"' \
                /tmp/compliance-results.json >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "## OpenResponses Conformance: Results unavailable" >> $GITHUB_STEP_SUMMARY
            echo "Could not parse compliance test output." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-results
          path: /tmp/compliance-results.json
          retention-days: 30

      - name: Server logs on failure
        if: failure()
        run: |
          echo "=== Mock backend logs ==="
          kill ${{ env.MOCK_PID }} 2>/dev/null || true
          echo "=== Server logs ==="
          kill ${{ env.SERVER_PID }} 2>/dev/null || true

  sdk-clients:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Build binaries
        run: |
          go build -o bin/server ./cmd/server/
          go build -o bin/mock-backend ./cmd/mock-backend/

      - name: Start mock backend
        run: |
          MOCK_PORT=9090 ./bin/mock-backend &
          echo "MOCK_PID=$!" >> $GITHUB_ENV

      - name: Start antwort server
        run: |
          ANTWORT_BACKEND_URL="http://localhost:9090" \
          ANTWORT_MODEL="mock-model" \
          ANTWORT_PORT="8080" \
          ANTWORT_STORAGE="memory" \
          ./bin/server &
          echo "SERVER_PID=$!" >> $GITHUB_ENV

      - name: Wait for services
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/healthz > /dev/null 2>&1; then
              echo "Services ready after ${i}s"
              exit 0
            fi
            sleep 1
          done
          echo "ERROR: Services did not start within 30s"
          exit 1

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python SDK dependencies
        run: pip install -r test/sdk/python/requirements.txt

      - name: Run Python SDK tests
        run: pytest test/sdk/python/ -v

      - uses: oven-sh/setup-bun@v2

      - name: Install TypeScript SDK dependencies
        run: cd test/sdk/typescript && bun install

      - name: Run TypeScript SDK tests
        run: cd test/sdk/typescript && bun test

      - name: Server logs on failure
        if: failure()
        run: |
          echo "=== Mock backend logs ==="
          kill ${{ env.MOCK_PID }} 2>/dev/null || true
          echo "=== Server logs ==="
          kill ${{ env.SERVER_PID }} 2>/dev/null || true

  kubernetes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Build container images
        run: |
          docker build -t antwort:ci -f Containerfile .
          docker build -t mock-backend:ci -f Containerfile.mock .

      - name: Install kind
        run: go install sigs.k8s.io/kind@latest

      - name: Create kind cluster
        run: kind create cluster --name ci --wait 60s

      - name: Load images into kind
        run: |
          kind load docker-image antwort:ci --name ci
          kind load docker-image mock-backend:ci --name ci

      - name: Deploy to cluster
        run: |
          kubectl create namespace antwort
          kubectl apply -k quickstarts/01-minimal/ci -n antwort

      - name: Wait for pods
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=antwort -n antwort --timeout=60s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=mock-backend -n antwort --timeout=60s

      - name: Health checks
        run: |
          kubectl port-forward -n antwort svc/antwort 8080:8080 &
          sleep 3
          curl -sf http://localhost:8080/healthz
          curl -sf http://localhost:8080/readyz

      - name: Smoke test
        run: |
          RESPONSE=$(curl -sf -X POST http://localhost:8080/v1/responses \
            -H 'Content-Type: application/json' \
            -H 'Authorization: Bearer test' \
            -d '{"model":"mock-model","input":"hello"}')
          echo "$RESPONSE" | jq .
          STATUS=$(echo "$RESPONSE" | jq -r '.status')
          if [ "$STATUS" != "completed" ]; then
            echo "ERROR: Expected status 'completed', got '$STATUS'"
            exit 1
          fi

      - name: Pod logs on failure
        if: failure()
        run: |
          echo "=== Antwort Pod logs ==="
          kubectl logs -n antwort -l app.kubernetes.io/name=antwort --tail=50 2>/dev/null || true
          echo "=== Mock backend Pod logs ==="
          kubectl logs -n antwort -l app.kubernetes.io/name=mock-backend --tail=50 2>/dev/null || true
          echo "=== Pod status ==="
          kubectl get pods -n antwort -o wide 2>/dev/null || true
          echo "=== Events ==="
          kubectl get events -n antwort --sort-by='.lastTimestamp' 2>/dev/null || true

      - name: Cleanup
        if: always()
        run: kind delete cluster --name ci

  # Trigger website rebuild when docs change on main
  docs-deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for docs changes
        id: docs-check
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE '^docs/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger website rebuild
        if: steps.docs-check.outputs.changed == 'true'
        run: |
          curl -sf -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.WEBSITE_DISPATCH_TOKEN }}" \
            https://api.github.com/repos/antwort-dev/antwort-dev.github.io/dispatches \
            -d '{"event_type":"docs-updated"}'
          echo "Triggered website rebuild"
