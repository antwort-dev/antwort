name: API Conformance

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  api-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Install oasdiff
        run: go install github.com/oasdiff/oasdiff@latest

      - name: Run oasdiff validation
        run: ./api/validate-oasdiff.sh

      - name: Run integration tests
        run: go test ./test/integration/ -timeout 120s -v -count=1

      - name: Run unit tests
        run: go test ./pkg/... -timeout 60s -count=1

  openresponses-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Build binaries
        run: |
          go build -o bin/server ./cmd/server/
          go build -o bin/mock-backend ./cmd/mock-backend/

      - name: Start mock backend
        run: |
          MOCK_PORT=9090 ./bin/mock-backend &
          echo "MOCK_PID=$!" >> $GITHUB_ENV

      - name: Start antwort server
        run: |
          ANTWORT_BACKEND_URL="http://localhost:9090" \
          ANTWORT_MODEL="mock-model" \
          ANTWORT_PORT="8080" \
          ANTWORT_STORAGE="memory" \
          ./bin/server &
          echo "SERVER_PID=$!" >> $GITHUB_ENV

      - name: Wait for services
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/healthz > /dev/null 2>&1; then
              echo "Services ready after ${i}s"
              exit 0
            fi
            sleep 1
          done
          echo "ERROR: Services did not start within 30s"
          exit 1

      - uses: oven-sh/setup-bun@v2

      - name: Clone OpenResponses compliance suite
        run: git clone --depth 1 https://github.com/openresponses/openresponses.git /tmp/openresponses

      - name: Install compliance suite dependencies
        run: cd /tmp/openresponses && bun install --frozen-lockfile

      - name: Run compliance tests (JSON)
        id: compliance
        run: |
          cd /tmp/openresponses
          bun run bin/compliance-test.ts \
            --base-url "http://localhost:8080/v1" \
            --model "mock-model" \
            --api-key "test" \
            --json > /tmp/compliance-results.json 2>&1 || true
          cat /tmp/compliance-results.json

      - name: Run compliance tests (verbose)
        run: |
          cd /tmp/openresponses
          bun run bin/compliance-test.ts \
            --base-url "http://localhost:8080/v1" \
            --model "mock-model" \
            --api-key "test"

      - name: Generate summary
        if: always()
        run: |
          if [ -f /tmp/compliance-results.json ] && jq -e '.summary' /tmp/compliance-results.json > /dev/null 2>&1; then
            PASSED=$(jq -r '.summary.passed' /tmp/compliance-results.json)
            FAILED=$(jq -r '.summary.failed' /tmp/compliance-results.json)
            TOTAL=$(jq -r '.summary.total' /tmp/compliance-results.json)

            echo "## OpenResponses Conformance: ${PASSED}/${TOTAL}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test | Status | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|----------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | "| \(.id) | \(if .status == "passed" then "PASS" else "FAIL" end) | \(.duration // "-")ms |"' \
              /tmp/compliance-results.json >> $GITHUB_STEP_SUMMARY

            if [ "$FAILED" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Failures" >> $GITHUB_STEP_SUMMARY
              jq -r '.results[] | select(.status == "failed") | "- **\(.id)**: \(.errors[0] // "unknown")"' \
                /tmp/compliance-results.json >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "## OpenResponses Conformance: Results unavailable" >> $GITHUB_STEP_SUMMARY
            echo "Could not parse compliance test output." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-results
          path: /tmp/compliance-results.json
          retention-days: 30

      - name: Server logs on failure
        if: failure()
        run: |
          echo "=== Mock backend logs ==="
          kill ${{ env.MOCK_PID }} 2>/dev/null || true
          echo "=== Server logs ==="
          kill ${{ env.SERVER_PID }} 2>/dev/null || true
